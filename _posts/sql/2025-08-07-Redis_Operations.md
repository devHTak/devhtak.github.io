### 레디스 운용 관리

#### 데이터 영속성
- 레디스는 인메모리 DB 특성 상 기본적으로 모든 데이터를 메모리에서 처리하기 떄문에 서버가 재시작되면 데이터가 유실 될 수 있다.
- 캐시로 사용한다면 성능상의 이슈는 발생할 수 있지만 데이터 휘발성이 큰 문제가 되지 않는다.
  - 그러나 캐시 미스로 인해 RDBMS에 다시 데이터를 요청할 때 성능에 어느 정도 영향을 미치는지, 과부하가 발생하지 않는지 등을 충분히 검토해야 한다.
- 캐시가 아닌 데이터 저장소처럼 데이터 영속성을 전제로 운영하는 경우
  - 영속성을 위한 설정이 있지만, 영속성 관련 기능을 모두 활성화하는 것은 권장하지 않는다.
  - 성능과 내구성의 타협점을 찾고 그에 맞춰 설정해야 한다.
- 레디스는 snapshot과 AOF 두가지 방법으로 데이터 영속성 보장
  - snapshot, AOF, snapshot + AOF, 영속성을 사용하지 않는 4가지 방법이 있고, 이 방식을 사용해 백업을 만들 수 있다.
- 기본적으로 snapshot 이 기본값으로 설정되어 있음

##### 스냅샷
- 특정 시점의 DB 내에 있는 내용을 RDB(Redis Database)라는 형식의 파일로 저장
- 수동에 경우 SAVE(동기), BGSAVE(비동기) 명령어 사용
  - SAVE 명령어는 동일한 스레드내에 RDB 파일을 생성하기 때문에 Dump 중에 다른 요청은 차단되므로 실제 운영에선 사용하지 않는다.
  - BGSAVE는 RDB 덤프하기 위한 자식 프로세스를 포크처리하여 생성한 후 자식 프로세스가 데이터 세트 전체를 임시 RDB 파일로 덤프한다.
  - 이후 덤프처리가 완료되면 RDB 파일 이름 변경
- 자동으로 설정하면 정해진 시간 내에 최소 몇개의 키가 변경되었는지 기준 설정
- RDB 파일을 덤프하기 위한 자식 프로세스를 생성할 때는 CoW(Copy On Write) 메커니즘을 사용해 메모리를 확보
- RDB 파일은 Amazon S3 등에 저장하여 운영할 수 있으며, 복원을 위해 지정한 디렉터리에 배치하여 실행
  - 그 외 파일 압축, 체크섬 등 튜닝할 수 있다.
- 백그라운드에서 snapshot 처리에 실패하게 되면, 기본적으로 쓰기 작업 요청을 수락하지 않는다.

##### AOF(Append Only File)
- snapshot의 단점은 레디스에 장애가 발생하면 이전 snapshot 이후 데이터는 당연히 손실된다.
- 반면 AOF는 거의 실시간 백업 처럼 작성중인 파일 끝에 계속 추가하여 기록하기 때문에 내구성이 높다.
- AOF는 자동 생성만 할 수 있다.

##### snapshot과 AOF 비교
- snapshot 장점
  - 특정 시점의 상태를 덤프하며 파일 크기가 작다
  - 자식 프로세스의 포크 처리 시에만 성능 영향을 미치며 나머지 처리는 백그라운드에서 수행되어 성능에 미치는 영향이 작다
- snapshot 단점
  - 데이터 손실 가능
- AOF 장점
  - 데이터 내구성이 높다
- AOF 단점
  - 트랜잭션 로그를 REDO 로그 형태로 기록하며, 실제 데이터를 기록하지 않기 떄문에 같은 데이터 세트라도 AOF 파일 크기가 더 커질 수 있다.
  - snapshot 보다 성능 저하에 미치는 영향이 더 크며 레디스 서버를 시작할 때 파일 로딩에 시간이 걸릴 수 있다.

##### 데이터 삭제 패턴
- 데이터 손실될 수 있는 상황
  - 엔진 재시작
  - 레디스 서버 전체 장애
  - 명령어 실행(DEL, FLUSHALL, UNLINK ..)
  - TTL 만료 (EXPIRE, SET 명령어의 EX 옵션)
  - 강제 제거
  - 비동기 레플리케이션
  - 레디스 클러스터의 네트워크 단절
  - 기타 (키 이름 재설정 등)
- 레디스 레플리카는 비동기 형태를 취하기 때문에 반영되지 않은 상태에서 마스터가 다운되면 데이터 손실이 발생할 수 있다.
- 네트워크 단절 영향이 있을 수 있다.
- AWS Elasticache 관리형에 경우 데이터 삭제 복원에 대해 이해 필요
  - 장애 감지 및 자동 복구
    - ElastiCache는 기본 노드(Primary)나 읽기 전용 복제본(replica)에서 장애가 발생하면 이를 자동으로 감지하고, 해당 노드를 오프라인 상태로 전환한 뒤 새 노드를 생성하고 동기화
    - 읽기 전용 복제본이 장애 시, 동일한 가용 영역(AZ)에서 대체 노드를 자동으로 생성. 이 기간에도 애플리케이션은 다른 복제본과 기본 노드 사용 가능
  - 자동 장애 조치(Automatic Failover)
    - 다중 AZ 구성에서는 기본 노드에 장애가 발생하면 가장 최신 데이터를 가진 읽기 전용 복제본이 자동으로 Primary로 승격
    - 기존 엔드포인트를 계속 사용할 수 있어 애플리케이션 변경 불필요
    - 장애 감지~복구까지 일반적으로 6분 이내 완료. 장애 조치 중에는 아웃풋 메시지로 상태 변경을 알리므로 모니터링 가능
  - 재해 복구/데이터 손실 가능성
    - Redis 복제는 비동기식이므로, 장애 시점에 따라 소량의 데이터가 손실 가능
    - ElastiCache는 복제 지연이 가장 짧은 최신 복제본을 Primary로 선택해 데이터 손실을 최소화
    - 전체 클러스터 장애(모든 노드에 장애 발생)와 같은 극히 드문 경우에는 데이터가 완전히 손실될 수 있으며, 이 경우 백업 또는 스냅샷으로 복구해야 한다.
  - 백업 및 복원
    - 관리 콘솔 또는 API를 통해 자동 또는 수동 백업(스냅샷)을 설정할 수 있으며 장애나 데이터 손실 시, 이전 시점의 데이터로 클러스터를 복원 가능
  - 운영 자동화
    - 노드의 상태 감지, 장애 복구, 패치, 백업, 가용성 유지 등은 AWS가 자동화하여 관리합니다.
  - 장애 조치 시 주의 사항
    - 고객이 직접 실행하는 노드 재부팅은 자동 장애조치를 트리거하지 않습니다.

#### 모범사례

#### 캐시 노드 크기 조정
