### 메모리 관리

#### 1. 메모리 관리 아키텍처
- 레디스 메모리 구조
  - 데이터
  - 데이터 구조 오버헤드
  - 클라이언트 쿼리 버퍼
  - 클라이언트 출력 버퍼
  - AOF 버퍼
  - AOF 재작성 버퍼
  - 레플리케이션 백로그
  - 레디스 함수
  - 이페머럴 스크립트
  - 메모리 단편화
 
##### INFO Memory 출력 결과 해석
- used_memory: 레디스가 jemalloc 같은 메모리 할당자를 사용해 할당한 메모리 크기 
  - 해당 메모리는 클라이언트 출력 버퍼 등도 포함되어 데이터만 사용하는 것이 아니다
- maxmemory: 레디스가 사용할 수 있는 최대 메모리 크기
- used_memory가 maxmemory 를 넘으면 maxmemory-policy 지시자로 설정한 값을 따르도록 동작
  - mem_not_counted_for_evict 는 AOF 버퍼, RDB 스냅샷을 생성할 때 CoW 에 의해 사용된 메모리양의 합으로
  - used_memory - mem_not_counted_for_evict <= maxmemory
- used_memory_overhead 는 서버에 할당된 오버헤드를 관리하는 데 사용되는 내부 데이터 구조
  - used_memory_dataset = used_memory - used_memory_overhead (데이터 세트의 메모리 크기)
- mem_cluster_links 값과 send-buffer-allocated 값
  - 레디스 클러스터의 클러스터 버스에서 캐시 노드가 다른 노드와의 연결에 사용하는 메모리 정보
- mem_fragmentation_ratio: 메모리 단편화 비율
  - 레디스가 현재 사용중인 것으로 인식하는 메모리 사용량을 RSS 값을 나눈 값
  - mem_fragmentation_ratio = used_memory_rss / used_memory
- 메모리 단편화 문제 대처 방법
  - 단편화율이 1.5 이상이면 단편화가 심각하고 성능 문제가 발생할 수 있다.
  - 반대로 1.0 보다 낮으면 스왑이 발생하고 있을 가능성이 있다.
  - 단편화 발생 시 대처 방법
    - 레디스 재시작 (RDB, AOF 파일 불러오기를 통해 데이터 복원)
    - 동적 단편화
    - 메모리 스왑 제한
    - 메모리 할당자 변경
    - MEMORY PURGE 명령어 실행
      - 메모리 사용량이 높은 최대 사용량 시간에도 jemalloc 메모리를 즉시 해제하지 않는 상황에서 메모리를 재사용하고자 할 떄 유용

##### 클라이언트 출력 버퍼(COB Client Output Buffer)
- COB는 서버로부터 데이터를 즉시 읽지 못하는 클라이언트의 연결을 강제로 끊는 용도로 사용
- 서버는 클라이언트마다 COB를 갖추고 처리한 결과를 클라이언트에 보내지 않고 COB 저장, COB에 저장된 정보가 클라이언트에 한번에 전송
  - 버퍼 크기가 커질 수 있는 상황은 다루는 "데이터 크기가 클 때", "스토리지가 느릴 때", "네트워크 환경이 좋지 않을 때"
- 클라이언트 출력 버퍼 종류
  - pubsub 유형(redis pub/sub 기능)은 버퍼 크기에 제한을 두어 클라이언트의 출력 버퍼가 초과되면 연결을 끊을 수 있다
  - replica 유형은 마스터에서 버퍼링하는 영역
  - normal 유형은 일반적인 클라이언트의 연결에 사용되는 버퍼 영역
  - client-output-buffer-limit 지시자는 레디스에서 클라이언트 출력 버퍼의 크기 제한을 설정할 때 사용

#### 2. 키 만료


#### 3. 메모리를 효율적으로 사용하기 위한 기타 방법
- 메모리를 효율적으로 사용하기 위한 동적 리해싱(active rehashing), 동적 단편화 제거(active defragmentation) 기법

##### 동적 리해싱
- 레디스는 하나의 큰 해시 테이블을 사용해 데이터 관리
  - 동적 리해싱 방식은 해당 해시 테이블 크기를 사용하려는 상황에 맞추어 자동 조정
  - CPU 시간의 100ms 중 1ms 만큼 사용하여 리해싱 중인 테이블 관련 작업이 있을 때마다 점진적 진행
- 해시 테이블의 크기는 2의 거듭 제곱 단위로 충돌 시 체이닝 방식 사용
- 리해싱 과정에서 크기가 조정된 새로운 테이블 추가, 새로운 아이템이 이 테이블에 저장되도록 한다.
  - 데이터가 모두 이동하면 이전 테이블 삭제
  - 만약 레디스의 응답으로 인해 쿼리가 2ms 만큼 지연되는 것이 문제된다면 비활성화하는 것이 좋다.
- activerehashing 지시어로 활성화할 수 있다.

##### 동적 단편화 제거
- 메모리 단편화가 발생할 수 있다.
  - 단편화는 모든 메모리 할당자에서 발생하지만 jemalloc 은 그중에서도 단편화가 덜 발생하도록 설계되어 있어 사용하는 것 권장
- 동적 단편화 제거 기법을 사용하면 재시작 같은 조치없이도 단편화 문제를 해결할 수 있다.
  - 특정 임계값을 초과하면 jemalloc 기능을 사용하여 연속된 메모리 영역에 새로운 데이터의 레플리카 생성 후 오래된 데이터를 해제하는 방식 진행
  - 모든 키에 대해 점진적으로 반복적으로 수행하여 정상 범위까지 감소
